import{L as ee,r as o,p as u}from"./Z3C1zjOC.js";import{U as W}from"./DnZbvBXp.js";import{C as k}from"./DTkYgPEM.js";import D from"./Dxmh1sec.js";const le=ee("admin",()=>{const d=o([]),c=o([]),l=o([]),t=o(!1),n=o(null),m=o(""),f=o(""),g=o(""),h=o(""),w=o(""),C=o(""),p=o(""),y=o(""),E=o(""),A=o(""),L=o(""),x=u(()=>d.value.filter(e=>{const a=!m.value||e.name.toLowerCase().includes(m.value.toLowerCase()),r=!f.value||e.email.toLowerCase().includes(f.value.toLowerCase());return a&&r})),q=u(()=>d.value.length),R=u(()=>x.value.length),M=u(()=>c.value.filter(e=>{const a=!g.value||e.name.toLowerCase().includes(g.value.toLowerCase()),r=!h.value||e.category&&e.category.toLowerCase().includes(h.value.toLowerCase()),s=!w.value||e.user&&e.user.name.toLowerCase().includes(w.value.toLowerCase()),v=!C.value||e.user&&e.user.email.toLowerCase().includes(C.value.toLowerCase()),i=!p.value||e.session&&e.session.toLowerCase().includes(p.value.toLowerCase());return a&&r&&s&&v&&i})),V=u(()=>c.value.length),b=u(()=>M.value.length),_=u(()=>l.value.filter(e=>{const a=!y.value||e.device_name.toLowerCase().includes(y.value.toLowerCase()),r=!E.value||e.user&&e.user.name.toLowerCase().includes(E.value.toLowerCase()),s=!A.value||e.user&&e.user.email.toLowerCase().includes(A.value.toLowerCase()),v=!L.value||e.enddevice_id.toLowerCase().includes(L.value.toLowerCase());return a&&r&&s&&v})),j=u(()=>l.value.length),z=u(()=>_.value.length),B=async()=>{try{t.value=!0,n.value=null;const e=await W.getAllUsers();d.value=e.data||[],console.log("âœ… AdminStore: Usuarios cargados exitosamente")}catch(e){throw console.error("âŒ AdminStore: Error cargando usuarios:",e),n.value="Error al cargar usuarios",e}finally{t.value=!1}},G=async e=>{try{t.value=!0,n.value=null,await W.delete(e,!0);const a=d.value.findIndex(r=>r.id===e);return a!==-1&&d.value.splice(a,1),console.log("âœ… AdminStore: Usuario eliminado exitosamente"),!0}catch(a){throw console.error("âŒ AdminStore: Error eliminando usuario:",a),n.value="Error al eliminar usuario",a}finally{t.value=!1}},H=async()=>{var e,a,r;try{t.value=!0,n.value=null,console.log("ðŸ”„ AdminStore: Iniciando carga de cultivos...");const s=await k.getAllWithUsers();s&&s.success?(c.value=s.data||[],console.log("âœ… AdminStore: Cultivos cargados exitosamente:",c.value.length)):(c.value=[],console.log("âš ï¸ AdminStore: Respuesta sin datos de cultivos"))}catch(s){if(console.error("âŒ AdminStore: Error cargando cultivos:",s),console.error("âŒ Error details:",{message:s.message,status:s.status,statusCode:s.statusCode,response:(e=s.response)==null?void 0:e.data}),c.value=[],n.value=s.message||"Error al cargar cultivos",!((a=s.message)!=null&&a.includes("404"))&&!((r=s.message)!=null&&r.includes("No se encontraron")))throw s}finally{t.value=!1}},J=async e=>{try{t.value=!0,n.value=null,await k.delete(e);const a=c.value.findIndex(r=>r.id===e);return a!==-1&&c.value.splice(a,1),console.log("âœ… AdminStore: Cultivo eliminado exitosamente"),!0}catch(a){throw console.error("âŒ AdminStore: Error eliminando cultivo:",a),n.value="Error al eliminar cultivo",a}finally{t.value=!1}},K=async()=>{try{t.value=!0,n.value=null;const e=await D.getAllWithUsers();l.value=e.data||[],console.log("âœ… AdminStore: Dispositivos cargados exitosamente")}catch(e){throw console.error("âŒ AdminStore: Error cargando dispositivos:",e),n.value="Error al cargar dispositivos",e}finally{t.value=!1}},O=async e=>{try{t.value=!0;const a=await D.delete(e);if(a.success)return l.value=l.value.filter(r=>r.id!==e),{success:!0};throw new Error(a.message||"Error al eliminar dispositivo")}catch(a){throw console.error("Error al eliminar dispositivo:",a),a}finally{t.value=!1}},Q=async e=>{try{return await D.checkActiveDevicesForUser(e)}catch(a){throw console.error("Error al verificar dispositivos activos:",a),a}},T=async(e,a=!1)=>{var r,s,v;try{t.value=!0;const i=await D.activateDevice(e,a);if(i.success){const F=l.value.findIndex(U=>U.id===e);if(F!==-1&&(l.value[F].is_active_communication=!0,a&&l.value[F].user_id)){const U=l.value[F].user_id;l.value.forEach(S=>{S.user_id===U&&S.id!==e&&(S.is_active_communication=!1)})}return{success:!0,data:i.data,message:i.message}}throw new Error(i.message||"Error al activar dispositivo")}catch(i){if(console.error("Error al activar dispositivo:",i),i.status===409||i.statusCode===409)return{success:!1,requiresConfirmation:!0,activeDevices:((r=i.data)==null?void 0:r.activeDevices)||[],targetDevice:((s=i.data)==null?void 0:s.targetDevice)||null,message:((v=i.data)==null?void 0:v.message)||"El usuario ya tiene un dispositivo activo"};throw i}finally{t.value=!1}},X=async e=>{try{t.value=!0;const a=await D.deactivateDevice(e);if(a.success){const r=l.value.findIndex(s=>s.id===e);return r!==-1&&(l.value[r].is_active_communication=!1),{success:!0,data:a.data,message:a.message}}throw new Error(a.message||"Error al desactivar dispositivo")}catch(a){throw console.error("Error al desactivar dispositivo:",a),a}finally{t.value=!1}},Y=(e="",a="")=>{m.value=e,f.value=a},Z=(e="",a="",r="",s="",v="")=>{g.value=e,h.value=a,w.value=r,C.value=s,p.value=v},$=(e="",a="",r="",s="")=>{y.value=e,E.value=a,A.value=r,L.value=s},I=()=>{m.value="",f.value=""},N=()=>{g.value="",h.value="",w.value="",C.value="",p.value=""},P=()=>{y.value="",E.value="",A.value="",L.value=""};return{users:d,crops:c,devices:l,isLoading:t,error:n,nameFilter:m,emailFilter:f,cropNameFilter:g,cropCategoryFilter:h,cropUserFilter:w,cropEmailFilter:C,cropSessionFilter:p,deviceNameFilter:y,deviceUserFilter:E,deviceEmailFilter:A,deviceEndDeviceFilter:L,filteredUsers:x,totalUsers:q,filteredUsersCount:R,filteredCrops:M,totalCrops:V,filteredCropsCount:b,filteredDevices:_,totalDevices:j,filteredDevicesCount:z,fetchAllUsers:B,deleteUser:G,fetchAllCrops:H,deleteCrop:J,fetchAllDevices:K,deleteDevice:O,checkActiveDevicesForUser:Q,activateDeviceWithValidation:T,deactivateDevice:X,updateFilters:Y,updateCropFilters:Z,updateDeviceFilters:$,clearFilters:I,clearCropFilters:N,clearDeviceFilters:P,reset:()=>{d.value=[],c.value=[],l.value=[],t.value=!1,n.value=null,I(),N(),P()}}});export{le as u};
