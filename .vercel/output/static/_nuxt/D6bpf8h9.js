import{E as ye,L as Ae,r as A,u as Ee,p,l as W}from"./Z3C1zjOC.js";import{u as Ce}from"./6yrW6Ic0.js";import{u as _e}from"./DPZQ8nY_.js";const l=()=>ye().public.apiUrl||"http://localhost:3001/api",u=()=>{const e=localStorage.getItem("AUTH_TOKEN");return e?{Authorization:`Bearer ${e}`}:{}},m={createIrrigationConfig(e){return $fetch("/irrigation",{method:"POST",body:e,baseURL:l(),headers:u()})},getIrrigationConfigById(e){return $fetch(`/irrigation/${e}`,{method:"GET",baseURL:l(),headers:u()})},deleteIrrigationConfig(e){return $fetch(`/irrigation/${e}`,{method:"DELETE",baseURL:l(),headers:u()})},getActiveIrrigationConfigsByUser(e){return $fetch(`/irrigation/user/${e}/active`,{method:"GET",baseURL:l(),headers:u()})},getIrrigationConfigsByUser(e){return $fetch(`/irrigation/user/${e}/all`,{method:"GET",baseURL:l(),headers:u()})},getIrrigationConfigsByUserAndType(e,r){return $fetch(`/irrigation/user/${e}/type/${r}`,{method:"GET",baseURL:l(),headers:u()})},activateIrrigationConfig(e){return $fetch(`/irrigation/${e}/activate`,{method:"PUT",baseURL:l(),headers:u()})},deactivateIrrigationConfig(e){return $fetch(`/irrigation/${e}/deactivate`,{method:"PUT",baseURL:l(),headers:u()})},updateLastIrrigation(e,r){return $fetch(`/irrigation/${e}/update-last-irrigation`,{method:"PUT",body:r,baseURL:l(),headers:u()})},getSpecificConfig(e){return $fetch(`/irrigation/${e}/specific-config`,{method:"GET",baseURL:l(),headers:u()})},updateManualConfig(e,r){return $fetch(`/irrigation/manual/${e}`,{method:"PUT",body:r,baseURL:l(),headers:u()})},createAutomaticConfig(e){return $fetch("/irrigation/automatic",{method:"POST",body:e,baseURL:l(),headers:u()})},createSimpleAutomaticConfig(e){return $fetch("/irrigation/automatic/simple",{method:"POST",body:e,baseURL:l(),headers:u()})},async getAutomaticConfigStatus(e){try{return await $fetch(`/irrigation/automatic/status/${e}`,{method:"GET",baseURL:l(),headers:u()})}catch(r){if(r.status===404||r.statusCode===404)return{success:!1,message:"No hay configuraci√≥n autom√°tica activa",data:null,isNotFound:!0};throw r}},async cancelAutomaticConfig(e){try{return await $fetch(`/irrigation/automatic/cancel/${e}`,{method:"DELETE",baseURL:l(),headers:u()})}catch(r){if(r.status===404||r.statusCode===404)return{success:!1,message:"No hay configuraci√≥n autom√°tica activa para cancelar",data:null,isNotFound:!0};throw r}},async evaluateAutomaticIrrigation(e){return await $fetch(`/irrigation/automatic/evaluate/${e}`,{method:"POST",baseURL:l(),headers:u()})},createProgrammedConfig(e){return $fetch("/irrigation/programmed",{method:"POST",body:e,baseURL:l(),headers:u()})},cancelProgrammedConfig(e){return $fetch(`/irrigation/programmed/${e}/cancel`,{method:"DELETE",baseURL:l(),headers:u()})},deleteProgrammedSettings(e){return $fetch(`/irrigation/programmed/${e}/settings`,{method:"DELETE",baseURL:l(),headers:u()})},cancelProgrammedIrrigation(e){return $fetch(`/irrigation/programmed/${e}/cancel-irrigation`,{method:"DELETE",baseURL:l(),headers:u()})},updateNextExecution(e,r){return $fetch(`/irrigation/programmed/${e}/next-execution`,{method:"PUT",body:r,baseURL:l(),headers:u()})},createIrrigationStartedAlert(e,r,g,s){return $fetch("/irrigation/alerts/started",{method:"POST",body:{user_id:e,mode:r,crop_name:g,duration_minutes:s},baseURL:l(),headers:u()})},createIrrigationEndedAlert(e,r,g,s=!0){return $fetch("/irrigation/alerts/ended",{method:"POST",body:{user_id:e,mode:r,crop_name:g,was_completed:s},baseURL:l(),headers:u()})},createIrrigationCancelledAlert(e,r,g){return $fetch("/irrigation/alerts/cancelled",{method:"POST",body:{user_id:e,mode:r,crop_name:g},baseURL:l(),headers:u()})},createIrrigationPausedAlert(e,r,g){return $fetch("/irrigation/alerts/paused",{method:"POST",body:{user_id:e,mode:r,crop_name:g},baseURL:l(),headers:u()})},createIrrigationResumedAlert(e,r,g){return $fetch("/irrigation/alerts/resumed",{method:"POST",body:{user_id:e,mode:r,crop_name:g},baseURL:l(),headers:u()})},updateProgrammedExecution(e,r){return $fetch(`/irrigation/programmed/${e}/execution`,{method:"PUT",body:r,baseURL:l(),headers:u()})},createPumpActivation(e){return $fetch("/irrigation/pump-activation",{method:"POST",body:e,baseURL:l(),headers:u()})},getActivePumpActivation(e){return $fetch(`/irrigation/pump-activation/config/${e}/active`,{method:"GET",baseURL:l(),headers:u()})},getLatestPumpActivationByConfig(e){return $fetch(`/irrigation/pump-activation/config/${e}/latest`,{method:"GET",baseURL:l(),headers:u()})},updatePumpActivationStatus(e,r){return $fetch(`/irrigation/pump-activation/${e}/status`,{method:"PUT",body:r,baseURL:l(),headers:u()})},pausePumpActivation(e){return $fetch(`/irrigation/pump-activation/${e}/pause`,{method:"PUT",baseURL:l(),headers:u()})},resumePumpActivation(e){return $fetch(`/irrigation/pump-activation/${e}/resume`,{method:"PUT",baseURL:l(),headers:u()})},completePumpActivation(e){return $fetch(`/irrigation/pump-activation/${e}/complete`,{method:"PUT",baseURL:l(),headers:u()})},getPumpActivationsByUser(e,r=10){return $fetch(`/irrigation/pump-activation/user/${e}/history?limit=${r}`,{method:"GET",baseURL:l(),headers:u()})},getLastIrrigationDate(e){return $fetch(`/irrigation/user/${e}/last-irrigation`,{method:"GET",baseURL:l(),headers:u()})},evaluateAutomaticIrrigation(e){return $fetch(`/irrigation/automatic/evaluate/${e}`,{method:"POST",baseURL:l(),headers:u()})},toggleAutomaticPump(e,r){return $fetch(`/irrigation/automatic/toggle/${e}`,{method:"POST",body:{action:r},baseURL:l(),headers:u()})}},O=window.setInterval,De=Ae("irrigation",()=>{const e=A(null),r=A(null),g=A(null),s=A(null),D=A(null),E=A(!1),h=A(null);let P=null,w=null;const C=Ee(),N=Ce(),{irrigationCompleted:q}=_e(),U=p(()=>e.value!==null),K=p(()=>e.value==="manual"),X=p(()=>e.value==="automatic"),J=p(()=>e.value==="programmed"),L=p(()=>{var a;return((a=s.value)==null?void 0:a.status)==="active"}),Q=p(()=>{var a;return((a=s.value)==null?void 0:a.status)==="paused"}),Y=p(()=>{var a;return((a=s.value)==null?void 0:a.status)==="completed"}),Z=p(()=>{var a;return((a=s.value)==null?void 0:a.status)==="programmed"}),b=A(null),ee=p(()=>{var a;if(!((a=g.value)!=null&&a.next_execution))return null;try{return new Date(g.value.next_execution).toLocaleString("es-ES",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"})}catch(t){return console.error("Error formateando next_execution:",t),null}}),$=A(!1),I=A(!1),z=p(()=>{if(!s.value||!L.value)return null;if(e.value==="automatic")return"Autom√°tico (basado en sensores)";const a=parseFloat(s.value.duration_minutes)||0;if(a===0)return console.log("‚ö†Ô∏è [SAFEGUARD] duration_minutes = 0 detectado, probablemente modo autom√°tico"),"Autom√°tico (basado en sensores)";if(!e.value)return console.log("‚ö†Ô∏è [SAFEGUARD] activeMode no definido, saltando c√°lculo de tiempo"),"Cargando...";const t=new Date(s.value.started_at),i=new Date,o=Math.floor((i-t)/1e3),n=a*60,c=Math.max(0,n-o);if(c<=0&&s.value.status==="active"&&!$.value&&!I.value&&e.value!=="automatic"&&e.value!==void 0&&a>0){const v=(i-t)/6e4;if(v<.5)return console.log("‚ö†Ô∏è [SAFEGUARD] Riego muy reciente, saltando auto-completado:",v.toFixed(2),"min"),`${d}:${f.toString().padStart(2,"0")}`;console.log("üö® TIEMPO AGOTADO - Auto-completando riego (ID:",s.value.id,")"),console.log("üîç [DEBUG] Contexto auto-completado:",{activeMode:e.value,durationMinutes:a,remainingSeconds:c,status:s.value.status,autoCompletionTriggered:$.value}),$.value=!0;const y=s.value.id;V().then(()=>{console.log("‚úÖ Auto-completado ejecutado exitosamente para ID:",y)}).catch(R=>{console.error("‚ùå Error en auto-completado:",R)})}const d=Math.floor(c/60),f=c%60;return`${d}:${f.toString().padStart(2,"0")}`});let _=null;const G=()=>{if(_&&clearInterval(_),e.value==="automatic"){console.log("‚ÑπÔ∏è Modo autom√°tico detectado - NO iniciando updates de tiempo");return}_=O(()=>{s.value&&L.value?z.value==="0:00"&&s.value.status==="active"&&console.log("‚è∞ Detectado 0:00 con bomba activa"):_&&(clearInterval(_),_=null)},1e3)},B=()=>{_&&(clearInterval(_),_=null)};W(()=>{var a;return(a=s.value)==null?void 0:a.id},(a,t)=>{a!==t&&a!==void 0&&t!==void 0?(console.log("üîÑ Nueva activaci√≥n detectada - reiniciando autoCompletionTriggered"),$.value=!1):a!==t&&console.log("‚ÑπÔ∏è [SKIP] Cambio de activaci√≥n ignorado (carga inicial o similar):",{newId:a,oldId:t})}),W(()=>{var a;return(a=s.value)==null?void 0:a.status},(a,t)=>{var i;if(t==="active"&&a==="completed"){console.log("üéâ Riego completado detectado por watcher");const o=((i=N.selectedCrop)==null?void 0:i.name)||"Cultivo";q(e.value,o)}});const ae=p(()=>{var a,t;if((a=r.value)!=null&&a.last_irrigation_at){const i=new Date(r.value.last_irrigation_at),n=Math.floor((new Date-i)/(1e3*60*60));return n<1?"Hace menos de 1 hora":n<24?`Hace ${n} horas`:`Hace ${Math.floor(n/24)} d√≠as`}if((t=D.value)!=null&&t.last_irrigation_at){const i=new Date(D.value.last_irrigation_at),n=Math.floor((new Date-i)/(1e3*60*60));return n<1?"Hace menos de 1 hora":n<24?`Hace ${n} horas`:`Hace ${Math.floor(n/24)} d√≠as`}return"Nunca"}),te=p(()=>a=>!U.value||e.value===a),oe=p(()=>!U.value||e.value==="manual"),re=p(()=>!U.value||e.value==="automatic"),ne=p(()=>!U.value||e.value==="programmed"),ie=async(a,t)=>{try{console.log("üîç Buscando configuraci√≥n manual para usuario:",a,"cultivo:",t);const i=await m.getIrrigationConfigsByUserAndType(a,"manual");if(i.success&&i.data.length>0){const o=i.data.find(n=>n.crop_id===t);if(o)return console.log("‚úÖ Configuraci√≥n manual encontrada:",o.id),o}return console.log("‚ùå No se encontr√≥ configuraci√≥n manual existente"),null}catch(i){return console.error("Error buscando configuraci√≥n manual:",i),null}},se=async()=>{var a;try{if(!((a=C.user)!=null&&a.id))return;const t=await m.getIrrigationConfigsByUserAndType(C.user.id,"manual");if(t.success&&t.data.length>0){const i=t.data.filter(o=>o.last_irrigation_at);if(i.length>0){const o=i.reduce((n,c)=>new Date(c.last_irrigation_at)>new Date(n.last_irrigation_at)?c:n);D.value=o,console.log("‚úÖ √öltima configuraci√≥n completada cargada:",o.last_irrigation_at)}}}catch(t){console.error("Error loading last completed configuration:",t)}},x=async()=>{var a;try{if(E.value=!0,h.value=null,!((a=C.user)!=null&&a.id))throw new Error("Usuario no autenticado");await se();const t=await m.getActiveIrrigationConfigsByUser(C.user.id);let i=!1;if(t.success&&t.data.length>0){const o=t.data[0];r.value=o,e.value=o.mode_type,o.mode_type==="automatic"?I.value=!0:I.value=!1,i=!0,await F(o.id),await H(o.id)}if(!i){console.log("üîç No hay configuraci√≥n activa, buscando configuraciones autom√°ticas preparadas o programadas pendientes...");try{const o=await m.getAutomaticConfigStatus(C.user.id);if(o.success&&o.data){console.log("ü§ñ Configuraci√≥n autom√°tica preparada encontrada:",o.data);const n={id:o.data.config_id,mode_type:"automatic",is_active:o.data.is_active,crop_id:o.data.crop_id,user_id:C.user.id};r.value=n,e.value="automatic",I.value=!0,i=!0,console.log("‚úÖ Configuraci√≥n autom√°tica preparada cargada en store - otros modos bloqueados")}}catch(o){console.log("‚ÑπÔ∏è No hay configuraci√≥n autom√°tica preparada:",o.message)}if(!i)try{const o=await m.getIrrigationConfigsByUser(C.user.id);if(o.success&&o.data.length>0){console.log(`üîç Encontradas ${o.data.length} configuraciones para revisar`);for(const n of o.data)try{const c=await m.getLatestPumpActivationByConfig(n.id);if(c.success&&c.data){const d=c.data;if(console.log(`üîç Config ${n.id} - √öltima activaci√≥n:`,d.status),d.status==="programmed"){console.log("‚úÖ Encontrada configuraci√≥n con activaci√≥n programada pendiente:",{configId:n.id,modeType:n.mode_type,activationStatus:d.status}),r.value=n,e.value=n.mode_type,s.value=d,i=!0,await F(n.id),console.log("‚úÖ Estado restaurado para configuraci√≥n programada");break}}}catch(c){console.error(`Error obteniendo activaci√≥n para config ${n.id}:`,c)}}}catch(o){console.error("Error buscando configuraciones programadas:",o)}}i||S()}catch(t){h.value=t.message,console.error("Error loading active configuration:",t)}finally{E.value=!1}},F=async a=>{var t;try{const i=await m.getSpecificConfig(a);i.success&&(g.value=i.data,e.value==="programmed"&&((t=g.value)!=null&&t.next_execution)&&j())}catch(i){console.error("Error loading specific configuration:",i)}},H=async a=>{try{const t=await m.getActivePumpActivation(a);t.success&&(s.value=t.data,t.data.status==="active"&&M())}catch{s.value=null}},ce=async a=>{var t,i;try{if(E.value=!0,h.value=null,console.log("üîÑ Iniciando riego manual con configuraci√≥n:",a),!((t=C.user)!=null&&t.id))throw new Error("Usuario no autenticado");if(!((i=N.currentCrop)!=null&&i.id))throw new Error("No hay cultivo seleccionado");const o=C.user.id,n=N.currentCrop.id;console.log("üîç Buscando configuraci√≥n manual existente para usuario:",o,"cultivo:",n);const c=await m.getIrrigationConfigsByUserAndType(o,"manual");let d=null;if(c.success&&c.data.length>0){const y=c.data.find(R=>R.crop_id===n);y&&(console.log("‚úÖ Configuraci√≥n manual existente encontrada:",y.id),d=y.id,console.log("‚úÖ Usando configuraci√≥n existente (integrada)"))}if(d){if(console.log("üîÑ Actualizando configuraci√≥n manual existente"),!(await m.updateManualConfig(d,{duration_minutes:a.duration_minutes})).success)throw new Error("Error actualizando configuraci√≥n manual");console.log("‚úÖ Configuraci√≥n manual actualizada")}else{console.log("üîÑ Creando nueva configuraci√≥n manual");const y=await m.createIrrigationConfig({user_id:o,crop_id:n,mode_type:"manual",duration_minutes:a.duration_minutes,is_active:!0});if(!y.success)throw new Error("Error creando configuraci√≥n de riego");d=y.data.id,console.log("‚úÖ Nueva configuraci√≥n de riego manual creada:",d)}if(console.log("üîÑ Activando configuraci√≥n de riego"),!(await m.activateIrrigationConfig(d)).success)throw new Error("Error activando configuraci√≥n de riego");console.log("‚úÖ Configuraci√≥n de riego activada"),console.log("üîÑ Creando activaci√≥n de bomba");const v=await m.createPumpActivation({irrigation_config_id:d,duration_minutes:a.duration_minutes,status:"active"});if(!v.success)throw new Error("Error creando activaci√≥n de bomba");return console.log("‚úÖ Activaci√≥n de bomba creada:",v.data.id),await x(),I.value=!1,M(),$.value=!1,G(),console.log("‚úÖ Riego manual iniciado exitosamente"),!0}catch(o){return h.value=o.message,console.error("‚ùå Error en startManualIrrigation:",o),!1}finally{E.value=!1}},le=async a=>{try{if(E.value=!0,h.value=null,console.log("üöÄ Iniciando configuraci√≥n de riego programado:",a),!a.user_id||!a.crop_id)throw new Error("Usuario y cultivo son obligatorios");const t=await m.createProgrammedConfig(a);if(t.success){console.log("‚úÖ Configuraci√≥n programada creada:",t.data),r.value=t.data.irrigationConfig,g.value=t.data.programmedConfig,s.value=t.data.pumpActivation,e.value="programmed",I.value=!1;const i=new Date(a.start_datetime),o=new Date,n=i-o;return console.log("üîç DEBUG: Comparaci√≥n de fechas",{scheduledTime:i.toISOString(),scheduledTimeLocal:i.toLocaleString(),now:o.toISOString(),nowLocal:o.toLocaleString(),timeUntilActivation:n,timeUntilActivationMinutes:Math.round(n/1e3/60),config:a}),n>0?(console.log(`‚è∞ Riego programado para: ${i.toLocaleString()}`),console.log(`‚è≥ Tiempo hasta activaci√≥n: ${Math.round(n/1e3/60)} minutos`),k(n)):console.log("‚ö†Ô∏è La fecha programada ya pas√≥",{scheduledTime:i.toLocaleString(),now:o.toLocaleString(),difference:n}),console.log("‚úÖ Estado local actualizado - NO llamando loadActiveConfiguration para evitar conflictos"),!0}else throw new Error(t.message||"Error al crear configuraci√≥n programada")}catch(t){return h.value=t.message,console.error("‚ùå Error iniciando riego programado:",t),!1}finally{E.value=!1}},k=a=>{w&&(clearInterval(w),w=null),w=O(()=>{var c,d;if(!((c=g.value)!=null&&c.start_datetime)){clearInterval(w),w=null;return}const i=new Date;new Date(g.value.start_datetime)-i<=0&&(clearInterval(w),w=null,((d=s.value)==null?void 0:d.status)==="programmed"?(console.log("üî• ¬°Tiempo de activaci√≥n alcanzado! Iniciando riego..."),ue()):console.log('‚ö†Ô∏è Tiempo alcanzado pero el estado ya no es "programmed", saltando activaci√≥n'))},1e3)},j=()=>{var t;if(!((t=g.value)!=null&&t.next_execution)){b.value=null;return}const a=()=>{var c;if(!((c=g.value)!=null&&c.next_execution)){b.value=null;return}const i=new Date,n=new Date(g.value.next_execution)-i;if(n<=0)b.value="Programado para activarse pronto";else{const d=Math.floor(n/864e5),f=Math.floor(n%(1e3*60*60*24)/(1e3*60*60)),v=Math.floor(n%(1e3*60*60)/(1e3*60));d>0?b.value=`${d}d ${f}h ${v}m`:f>0?b.value=`${f}h ${v}m`:b.value=`${v}m`}};a(),O(a,6e4)},ue=async()=>{var a,t,i,o,n,c;try{if(console.log("üî• ACTIVANDO RIEGO PROGRAMADO - M√âTODO SIMPLIFICADO"),((a=s.value)==null?void 0:a.status)!=="programmed"){console.log('‚ö†Ô∏è Riego ya no est√° en estado "programmed", saltando activaci√≥n');return}if(((t=r.value)==null?void 0:t.is_active)===!0){console.log("‚ö†Ô∏è Configuraci√≥n ya est√° activa, saltando activaci√≥n");return}if(!((i=r.value)!=null&&i.id)||!((o=s.value)!=null&&o.id))throw console.error("‚ùå Faltan datos necesarios:",{irrigationConfigId:(n=r.value)==null?void 0:n.id,pumpActivationId:(c=s.value)==null?void 0:c.id}),new Error("Faltan configuraciones necesarias");console.log("1Ô∏è‚É£ Activando configuraci√≥n de riego..."),await m.activateIrrigationConfig(r.value.id),r.value.is_active=!0,console.log("‚úÖ is_active = true establecido"),console.log("2Ô∏è‚É£ Activando bomba (status = active)...");const d=await m.updatePumpActivationStatus(s.value.id,{status:"active"});if(d.success)s.value=d.data,console.log("‚úÖ pump_status = active establecido"),M(),console.log("‚úÖ Monitoreo iniciado"),$.value=!1,G(),console.log("‚úÖ Updates de tiempo iniciados"),console.log("üéâ RIEGO PROGRAMADO ACTIVADO EXITOSAMENTE");else throw new Error("Error activando bomba")}catch(d){console.error("‚ùå ERROR ACTIVANDO RIEGO PROGRAMADO:",d)}},de=async()=>{var a;try{if(console.log("üìù Actualizando traza de ejecuci√≥n..."),!((a=g.value)!=null&&a.id)){console.log("‚ùå No hay specificConfig para actualizar traza");return}const t=new Date,i={last_execution:t.toISOString()},o=ge();if(o){i.next_execution=o.toISOString(),console.log(`üìÖ Pr√≥xima ejecuci√≥n calculada: ${o.toLocaleString()}`);const n=o-t;n>0&&(console.log("‚è∞ Programando pr√≥ximo riego..."),k(n),j())}else i.next_execution=null,console.log("üîö No hay m√°s ejecuciones programadas");await m.updateProgrammedExecution(g.value.id,i),console.log("‚úÖ Traza actualizada en BD")}catch(t){console.error("‚ùå Error actualizando traza:",t)}},ge=()=>{if(!g.value)return null;const{frequency_type:a,custom_days:t,start_datetime:i}=g.value,o=new Date,n=new Date(i);switch(a){case"once":return null;case"daily":const c=new Date(n);return c.setDate(c.getDate()+1),c;case"custom":if(!t||t.length===0)return null;const d=o.getDay()===0?7:o.getDay(),f=t.filter(we=>we!==d);if(f.length===0)return null;const v=Math.min(...f),y=v>d?v-d:7-d+v,R=new Date(n);return R.setDate(R.getDate()+y),me(f),R;default:return null}},me=async a=>{var t;try{if(!((t=g.value)!=null&&t.id))return;g.value.custom_days=a,console.log("üìÖ D√≠as restantes:",a)}catch(i){console.error("‚ùå Error actualizando custom_days:",i)}},fe=async()=>{var a;try{if(!((a=s.value)!=null&&a.id))throw new Error("No hay riego activo para pausar");const t=await m.pausePumpActivation(s.value.id);if(t.success)return s.value=t.data,T(),console.log("‚úÖ Riego pausado - la alerta se crear√° autom√°ticamente en el backend"),!0}catch(t){return h.value=t.message,!1}},ve=async()=>{var a;try{if(!((a=s.value)!=null&&a.id))throw new Error("No hay riego pausado para reanudar");const t=await m.resumePumpActivation(s.value.id);if(t.success)return s.value=t.data,M(),console.log("‚úÖ Riego reanudado - la alerta se crear√° autom√°ticamente en el backend"),!0}catch(t){return h.value=t.message,!1}},V=async()=>{var a,t,i,o;try{if(!((a=s.value)!=null&&a.id))return console.log("‚ùå No hay activaci√≥n de bomba activa para completar"),!1;if(console.log("üîÑ Completando riego...",{timestamp:new Date().toISOString(),stack:new Error().stack}),s.value.status==="completed")return console.log("‚ö†Ô∏è El riego ya est√° completado, ignorando llamada duplicada"),!0;if(B(),$.value=!1,!(await m.updatePumpActivationStatus(s.value.id,{status:"completed",ended_at:new Date().toISOString()})).success)throw new Error("Error completando riego");return(t=r.value)!=null&&t.id&&await m.updateLastIrrigation(r.value.id),e.value==="manual"&&((i=r.value)!=null&&i.id)?(console.log("üîÑ Desactivando configuraci√≥n manual (riego completado)"),(await m.deactivateIrrigationConfig(r.value.id)).success?console.log("‚úÖ Configuraci√≥n manual desactivada"):console.error("‚ùå Error desactivando configuraci√≥n manual")):e.value==="programmed"&&(console.log("üîÑ Procesando finalizaci√≥n de riego programado..."),(o=r.value)!=null&&o.id&&(await m.deactivateIrrigationConfig(r.value.id),console.log("‚úÖ Configuraci√≥n programada desactivada temporalmente")),await de(),console.log("‚úÖ Pr√≥xima ejecuci√≥n programada")),console.log("‚úÖ Riego completado - la alerta se crear√° autom√°ticamente en el backend"),S(),T(),await x(),console.log("‚úÖ Riego completado exitosamente"),!0}catch(n){return h.value=n.message,console.error("‚ùå Error en completeIrrigation:",n),!1}},pe=async()=>{var a,t,i,o,n,c,d;try{if(E.value=!0,console.log("üîÑ Iniciando cancelaci√≥n de modo activo...",e.value),e.value==="programmed")if(console.log("üîÑ Cancelando modo programado..."),w&&(clearInterval(w),w=null,console.log("‚úÖ Countdown detenido")),((a=s.value)==null?void 0:a.status)==="active"||((t=s.value)==null?void 0:t.status)==="paused"){if(console.log("üîÑ Cancelando SOLO riego activo (mantener configuraci√≥n)"),!(await m.cancelProgrammedIrrigation(r.value.id)).success)throw new Error("Error al cancelar riego programado");console.log("‚úÖ Riego programado cancelado - la alerta se crear√° autom√°ticamente en el backend"),console.log("‚úÖ Riego programado cancelado (configuraci√≥n mantenida)")}else{if(console.log("üîÑ Cancelando configuraci√≥n programada (SIN eliminar tupla)"),(i=r.value)!=null&&i.id){if(console.log("üîÑ Eliminando configuraci√≥n programada espec√≠fica"),!(await m.deleteProgrammedSettings(r.value.id)).success)throw new Error("Error al eliminar configuraci√≥n programada");console.log("‚úÖ Configuraci√≥n programada eliminada")}if((o=r.value)!=null&&o.id){if(console.log("üîÑ Desactivando configuraci√≥n de riego"),!(await m.deactivateIrrigationConfig(r.value.id)).success)throw new Error("Error al desactivar configuraci√≥n programada");console.log("‚úÖ Configuraci√≥n programada desactivada (tupla irrigation_configs conservada)")}}else{if((n=s.value)!=null&&n.id&&(s.value.status==="active"||s.value.status==="paused")){if(console.log("üîÑ Cancelando activaci√≥n de bomba:",s.value.id),!(await m.updatePumpActivationStatus(s.value.id,{status:"cancelled"})).success)throw new Error("Error cancelando activaci√≥n de bomba");if(console.log("‚úÖ Activaci√≥n de bomba cancelada"),console.log("‚úÖ Riego cancelado - la alerta se crear√° autom√°ticamente en el backend"),(c=r.value)!=null&&c.id){console.log("üîÑ Actualizando last_irrigation_at (riego cancelado)");try{await m.updateLastIrrigation(r.value.id),console.log("‚úÖ last_irrigation_at actualizado")}catch(v){console.error("‚ùå Error actualizando last_irrigation_at:",v)}}}if((d=r.value)!=null&&d.id){if(console.log("üîÑ Desactivando configuraci√≥n de riego:",r.value.id),!(await m.deactivateIrrigationConfig(r.value.id)).success)throw new Error("Error desactivando configuraci√≥n de riego");console.log("‚úÖ Configuraci√≥n de riego desactivada")}}return S(),T(),await new Promise(f=>setTimeout(f,300)),await x(),e.value!==null&&(console.warn("‚ö†Ô∏è El estado no se limpi√≥ correctamente, forzando limpieza manual"),S()),console.log("‚úÖ Modo activo cancelado exitosamente"),!0}catch(f){return h.value=f.message,console.error("‚ùå Error en cancelActiveMode:",f),!1}finally{E.value=!1}},M=()=>{T(),P=O(async()=>{var a;if((a=r.value)!=null&&a.id&&(await H(r.value.id),s.value&&s.value.status==="active")){const t=new Date(s.value.started_at),o=(new Date-t)/(1e3*60),n=parseFloat(s.value.duration_minutes)||0;(!s.value.started_at||!s.value.duration_minutes)&&console.warn("‚ö†Ô∏è [MONITOR] Datos incompletos:",{started_at:s.value.started_at,duration_minutes:s.value.duration_minutes,activationData:s.value}),console.log("‚è±Ô∏è [MONITOR] Estado del riego:",{elapsed:o.toFixed(2),duration:n,remainingTime:z.value,status:s.value.status})}},5e3)},T=()=>{P&&(clearInterval(P),P=null)},he=()=>{if(!e.value||!g.value)return"";switch(e.value){case"manual":const a=g.value.duration_minutes,t=Math.floor(a||0),i=Math.round((a-t)*60);return`Duraci√≥n: ${t}min ${i}seg`;case"programmed":if(g.value.start_datetime){const o=new Date(g.value.start_datetime),n=new Date;if(L.value)return`Duraci√≥n: ${g.value.duration_minutes}min`;{const c=o-n;if(c>0){const d=Math.floor(c/864e5),f=Math.floor(c%(1e3*60*60*24)/(1e3*60*60)),v=Math.floor(c%(1e3*60*60)/(1e3*60));return d>0?`Activa en ${d}d ${f}h ${v}m`:f>0?`Activa en ${f}h ${v}m`:`Activa en ${v}m`}else return"Activ√°ndose..."}}return"Programado para ejecutarse autom√°ticamente";case"automatic":return"Monitoreando sensores autom√°ticamente";default:return""}},S=()=>{e.value=null,r.value=null,g.value=null,s.value=null,D.value=null,h.value=null,$.value=!1,I.value=!1};return{activeMode:e,irrigationConfig:r,specificConfig:g,activePumpActivation:s,lastCompletedConfig:D,isLoading:E,error:h,hasActiveMode:U,isManualActive:K,isAutomaticActive:X,isProgrammedActive:J,isWatering:L,isPaused:Q,isCompleted:Y,isProgrammedWaiting:Z,remainingTime:z,lastIrrigation:ae,canAccessMode:te,canAccessManualMode:oe,canAccessAutomaticMode:re,canAccessProgrammedMode:ne,timeUntilNextExecution:b,nextExecutionFormatted:ee,loadActiveConfiguration:x,startManualIrrigation:ce,startProgrammedIrrigation:le,pauseIrrigation:fe,resumeIrrigation:ve,completeIrrigation:V,cancelActiveMode:pe,findManualConfigByUserAndCrop:ie,getModeDescription:he,startTimeUpdates:G,stopTimeUpdates:B,cleanup:()=>{T(),S()}}});export{m as I,O as s,De as u};
